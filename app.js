// Golf Course Data
const GOLF_COURSE_DATA = {"type":"FeatureCollection","features":[{"type":"Feature","properties":{"type":"green","hole":6,"color":"null"},"geometry":{"coordinates":[[[20.078030126006723,60.22323440091307],[20.078072001369094,60.22327759304923],[20.07809132845972,60.223291990415476],[20.07809132845972,60.22332718395043],[20.078133203822063,60.22334318099911],[20.078158973275862,60.22338637299194],[20.078158973275862,60.22341516762228],[20.07815253091266,60.22346155891799],[20.07811709791352,60.223522347412626],[20.078059116642663,60.22355434131222],[20.07799469300764,60.22356713886319],[20.07792060582824,60.22354154375623],[20.077907721100843,60.223493552876675],[20.077878730464903,60.22344716162624],[20.077817528011963,60.22341996672495],[20.07774344083262,60.223407169116484],[20.077675796016422,60.223383173587166],[20.077659159168263,60.22335541170338],[20.077663256453604,60.22331863826524],[20.077701601007305,60.22329036878003],[20.077737688797555,60.22328056836602],[20.07779371431448,60.223265300809146],[20.07783041273936,60.223237600332624],[20.077870004950285,60.223222372331776],[20.077921012918267,60.22321621523892],[20.07798527285462,60.2232182214271],[20.078030126006723,60.22323440091307]]],"type":"Polygon"}},{"type":"Feature","properties":{"type":"green","hole":11,"color":"null"},"geometry":{"coordinates":[[[20.077941351057007,60.224551572479385],[20.077897317742952,60.224612552073],[20.07775280124281,60.22464094386038],[20.07768410355453,60.224666403045575],[20.077610279173314,60.22467709589736],[20.0775077453101,60.22468626119618],[20.07745237702423,60.22467913263077],[20.077304727778255,60.224645526362536],[20.077247308815174,60.22462464981879],[20.077171433755865,60.22459511712475],[20.077142724274864,60.22453707002731],[20.077167332401558,60.22448920655401],[20.077202193915042,60.22445916455098],[20.077278068973328,60.22444694406724],[20.07735907205,60.224457636629495],[20.07739792153376,60.22449556203992],[20.07744611249774,60.22450829170123],[20.077541468990944,60.22452102134778],[20.077637850821674,60.22452102134778],[20.07775371408735,60.22451287437454],[20.07785214659623,60.22450014472474],[20.077902388188278,60.22451898460454],[20.077941351057007,60.224551572479385]]],"type":"Polygon"},"id":1},{"type":"Feature","properties":{"type":"green","hole":10,"color":"null"},"geometry":{"coordinates":[[[20.081851884826506,60.22223431255537],[20.081865326869462,60.22226697197249],[20.0818503185707,60.22229678664527],[20.081860324105094,60.22236904928914],[20.081907850385534,60.22240134841957],[20.081940368364712,60.22242992069795],[20.081982869371785,60.22247835252887],[20.08202539291827,60.22250940932486],[20.082002880471038,60.22254295058221],[20.081917833445544,60.22256034233126],[20.081847794718698,60.2225528887258],[20.081802769822588,60.22252804336094],[20.081796854399244,60.222495190316636],[20.081796854394497,60.22247158714839],[20.08176683779712,60.222441772634596],[20.08171931151756,60.22242562309461],[20.08165927832428,60.22241195809329],[20.08165677694089,60.222385870347836],[20.081689294921716,60.222365993956345],[20.081676788006376,60.22233617934651],[20.08162175758119,60.22230636470783],[20.08161175204927,60.22226040042281],[20.081651774179647,60.222218162913606],[20.08170930599107,60.222184621324374],[20.08178684886647,60.22219207501391],[20.081851884826506,60.22223431255537]]],"type":"Polygon"}},{"type":"Feature","properties":{"type":"pin","hole":10,"color":"null"},"geometry":{"coordinates":[20.081787222420957,60.22238867012214],"type":"Point"}},{"type":"Feature","properties":{"type":"green","hole":9,"color":"null"},"geometry":{"coordinates":[[[20.08196275724913,60.21906053209099],[20.082105801490428,60.21905114060243],[20.08215025231391,60.219048380843105],[20.082272492075447,60.219062179638],[20.082358615544678,60.21907183879074],[20.08237250642665,60.21908701745389],[20.08240862271981,60.21909943635501],[20.082455851719146,60.21912841377218],[20.082458629895882,60.21914773203619],[20.082475298953653,60.2191822289077],[20.08250308071834,60.21920292701324],[20.08251697159949,60.219215345870055],[20.08251697160034,60.21922776472334],[20.08250863707093,60.21924570305512],[20.0824891898356,60.21926226150134],[20.08246696443274,60.2192788199485],[20.082433626315407,60.219293998517685],[20.08239195366869,60.21929813813216],[20.08237528461001,60.219300897870085],[20.082294902690762,60.219298138128266],[20.082237796751542,60.21927579255842],[20.082196124073732,60.219246815263375],[20.08214056054598,60.219224737313226],[20.08207388431134,60.219199899601506],[20.08199053901882,60.21918886061252],[20.08188774648599,60.21919024048481],[20.08178495395896,60.21917920149252],[20.081718277725116,60.21915850337197],[20.08174328131227,60.219112967461],[20.081787732135695,60.2190839900299],[20.08189330283861,60.21906743148651],[20.08196275724913,60.21906053209099]]],"type":"Polygon"}},{"type":"Feature","properties":{"type":"pin","hole":9,"color":"null"},"geometry":{"coordinates":[20.082171640725647,60.21915159697255],"type":"Point"}},{"type":"Feature","properties":{"type":"green","hole":7,"color":"null"},"geometry":{"coordinates":[[[20.080215701760807,60.22314542027996],[20.080205272037688,60.22312192260128],[20.080206600432945,60.223103537682704],[20.080187794467037,60.22307273716575],[20.080197231813855,60.22302450737507],[20.08023801282698,60.22301004103065],[20.080299184324133,60.22300570112739],[20.080404049746022,60.22300570112739],[20.080508915168906,60.22301148766488],[20.08056717373728,60.223025954004214],[20.08062251937693,60.223037527071],[20.080712820157032,60.22304620686853],[20.080794382152618,60.22307224624683],[20.0808642924342,60.22309539234388],[20.080861379505507,60.22313011145843],[20.08080312093793,60.22316338390877],[20.080721558942344,60.22318942319421],[20.080625432264043,60.22319086981892],[20.08056717369655,60.22316772378932],[20.080465221202445,60.223159044024214],[20.080351616994307,60.22316772378932],[20.080285724041175,60.223163749552015],[20.080215701760807,60.22314542027996]]],"type":"Polygon"}},{"type":"Feature","properties":{"type":"pin","hole":7,"color":"null"},"geometry":{"coordinates":[20.08050852934744,60.223097164124766],"type":"Point"}},{"type":"Feature","properties":{"type":"green","hole":8,"color":"null"},"geometry":{"coordinates":[[[20.07981575084679,60.219123234265936],[20.079782303867972,60.21907962623402],[20.079807389082447,60.21904017128921],[20.07986174037967,60.21901525235231],[20.07989936820144,60.21897372074835],[20.079882644724677,60.2189321890921],[20.07982411255793,60.21890934665868],[20.07980320821295,60.21887819786019],[20.079849197772432,60.218838742673],[20.07992863428413,60.21881174699138],[20.080003889952906,60.21879098105751],[20.080158582108055,60.21879098105751],[20.08026310383292,60.218815900164856],[20.08034672121414,60.218861585146016],[20.08034672121414,60.21890311689168],[20.080355082951854,60.21894672516828],[20.080405253380917,60.218963337829706],[20.080438700333076,60.21898410364483],[20.080417795988097,60.21902148207843],[20.0803383594764,60.2190547073175],[20.08025474209518,60.2190650901976],[20.080229656880675,60.219031864969395],[20.08020457166623,60.21899240996714],[20.08012095428637,60.21896126124756],[20.08004987951233,60.218959184665295],[20.07999134734561,60.218988256806085],[20.079995528215164,60.21903394154708],[20.080024794297856,60.21907754964934],[20.080033156036933,60.21910869825845],[20.07999134734561,60.21912946398149],[20.07992445344115,60.21913361712467],[20.07981575084679,60.219123234265936]]],"type":"Polygon"}},{"type":"Feature","properties":{"type":"pin","hole":8,"color":"null"},"geometry":{"coordinates":[20.08007908147863,60.21888165719682],"type":"Point"}},{"type":"Feature","properties":{"type":"pin","hole":6,"color":"null"},"geometry":{"coordinates":[20.077943357414654,60.223365199559],"type":"Point"}},{"type":"Feature","properties":{"type":"green","hole":5,"color":"null"},"geometry":{"coordinates":[[[20.06864057264073,60.22502688304289],[20.06864620337811,60.225050443094526],[20.068664456539194,60.22507815594084],[20.068673968326835,60.22513773337826],[20.068673968326835,60.225180158405194],[20.068656527818405,60.22522673601974],[20.068621646802563,60.225262734457496],[20.06853305863699,60.22528214255017],[20.068444470472406,60.22528630005968],[20.068304509959987,60.22528630005968],[20.068206921630957,60.22527798752992],[20.068126458660657,60.225252074657414],[20.068046807339733,60.225211882003096],[20.06801192632389,60.22513357585942],[20.06798609247065,60.225065821437825],[20.06801192632389,60.22500693151039],[20.068063673577076,60.22496119630536],[20.068123992288945,60.22492922608017],[20.068184311000814,60.22491229608947],[20.06829047871735,60.22489536609438],[20.068430439230753,60.22489952359323],[20.068552276386476,60.224922282432585],[20.068673301891495,60.22496119630536],[20.068759386695055,60.22499316650898],[20.068811134948698,60.22501148526061],[20.06864057264073,60.22502688304289]]],"type":"Polygon"}},{"type":"Feature","properties":{"type":"pin","hole":5,"color":"null"},"geometry":{"coordinates":[20.06838955582619,60.22510107587084],"type":"Point"}},{"type":"Feature","properties":{"type":"green","hole":4,"color":"null"},"geometry":{"coordinates":[[[20.066961076672573,60.22659682738932],[20.066915296142176,60.22663115945043],[20.066836768988195,60.22666549147762],[20.06677301128649,60.226674075684794],[20.066686507042474,60.22667837817435],[20.066611586077787,60.22668697565231],[20.06651446066183,60.22668267316467],[20.066462102361395,60.22665264363134],[20.066463873091054,60.22661831162286],[20.06649803935451,60.22658613084908],[20.066570298778504,60.22653831267648],[20.066616080297294,60.22651688936776],[20.066720997047064,60.22648685984395],[20.066864824792646,60.22645468913378],[20.066963491152067,60.22644394042302],[20.067046489896753,60.22643749420213],[20.067107109253772,60.22643534670385],[20.067151346047863,60.22644824291088],[20.067179039759587,60.22648040735119],[20.067174098217197,60.226516888558146],[20.067110938132476,60.22655764973036],[20.067016501047777,60.22658552540869],[20.066961076672573,60.22659682738932]]],"type":"Polygon"}},{"type":"Feature","properties":{"type":"pin","hole":4,"color":"null"},"geometry":{"coordinates":[20.066869553877047,60.22655550226054],"type":"Point"}},{"type":"Feature","properties":{"type":"green","hole":3,"color":"null"},"geometry":{"coordinates":[[[20.067619050009664,60.22914068857363],[20.067681410851867,60.22914819178994],[20.067752612177412,60.22917321454932],[20.067806670934268,60.229201986148864],[20.06787056689842,60.22922250361682],[20.06790331115382,60.22924968849263],[20.067906964479507,60.2292799375383],[20.067895620763545,60.229304216164984],[20.067847836273885,60.229325608803925],[20.067756379111283,60.229341341890185],[20.067666748628975,60.229341341890185],[20.067586959624066,60.229338526097645],[20.067519812676913,60.229329878725725],[20.0674581236872,60.229307382466916],[20.0674113686158,60.22927419393662],[20.067385738893996,60.22923223874024],[20.067387390518323,60.22919512114388],[20.067396692730283,60.22915378931477],[20.067437995574197,60.229120584943165],[20.067493865959046,60.229098956862194],[20.06756761828155,60.22909034117717],[20.067619050009664,60.22914068857363]]],"type":"Polygon"}},{"type":"Feature","properties":{"type":"pin","hole":3,"color":"null"},"geometry":{"coordinates":[20.06760895662046,60.22923223873986],"type":"Point"}},{"type":"Feature","properties":{"type":"green","hole":1,"color":"null"},"geometry":{"coordinates":[[[20.06816485473033,60.22386464772621],[20.06819730024766,60.22387648033989],[20.068251979359295,60.22389716804471],[20.06835234970894,60.2239314327482],[20.068388772516255,60.22395488026638],[20.06844174829564,60.223972453822795],[20.068515998316005,60.22398071755319],[20.068562915362035,60.22399897962969],[20.068579706703564,60.22402794667306],[20.068574399331834,60.224055663540975],[20.06854778130387,60.22407580067896],[20.068507316307645,60.224090813767044],[20.068425271697905,60.22409875611816],[20.068337534459853,60.224096102993615],[20.068280205592546,60.22408111983766],[20.06821681468655,60.22404880766559],[20.0681779034976,60.22402383587234],[20.068138515308708,60.22399621645854],[20.06811643943604,60.223964909532244],[20.068116439431234,60.22392890242859],[20.06813851530396,60.22389289534167],[20.06816485473033,60.22386464772621]]],"type":"Polygon"}},{"type":"Feature","properties":{"type":"pin","hole":1,"color":"null"},"geometry":{"coordinates":[20.068360769846614,60.22398162448085],"type":"Point"}},{"type":"Feature","properties":{"type":"green","hole":2,"color":"null"},"geometry":{"coordinates":[[[20.067447803382513,60.229838903331556],[20.06745063629604,60.22988160663806],[20.067442350702157,60.229908950429096],[20.067412635925857,60.229925714854565],[20.067341206589305,60.22994935926965],[20.067285634680035,60.22995788425962],[20.067224405343526,60.2299535792623],[20.067181748495595,60.229933110906845],[20.06712749917154,60.229907022571634],[20.067109535264816,60.22987901195938],[20.067111364006313,60.22984031634759],[20.067133584230323,60.22980161820587],[20.067186181655686,60.22976292004046],[20.06727152009341,60.229717399756586],[20.067360516950044,60.229696177862175],[20.067432860672328,60.22968348092877],[20.067516719080327,60.22970609782229],[20.067609419969367,60.229740176622944],[20.067684549099488,60.22977002545506],[20.067724133743077,60.22980868399696],[20.067746353964516,60.229857997760966],[20.067732705366213,60.22990869534544],[20.067687172025704,60.22994873759825],[20.067635809874657,60.22997575992031],[20.067560680744569,60.22998281487804],[20.067491294093466,60.22997291365736],[20.067447803382513,60.229838903331556]]],"type":"Polygon"}},{"type":"Feature","properties":{"type":"pin","hole":2,"color":"null"},"geometry":{"coordinates":[20.067440160526877,60.22982312568606],"type":"Point"}},{"type":"Feature","properties":{"type":"green","hole":11,"color":"null"},"geometry":{"coordinates":[[[20.077941351057007,60.224551572479385],[20.077897317742952,60.224612552073],[20.07775280124281,60.22464094386038],[20.07768410355453,60.224666403045575],[20.077610279173314,60.22467709589736],[20.0775077453101,60.22468626119618],[20.07745237702423,60.22467913263077],[20.077304727778255,60.224645526362536],[20.077247308815174,60.22462464981879],[20.077171433755865,60.22459511712475],[20.077142724274864,60.22453707002731],[20.077167332401558,60.22448920655401],[20.077202193915042,60.22445916455098],[20.077278068973328,60.22444694406724],[20.07735907205,60.224457636629495],[20.07739792153376,60.22449556203992],[20.07744611249774,60.22450829170123],[20.077541468990944,60.22452102134778],[20.077637850821674,60.22452102134778],[20.07775371408735,60.22451287437454],[20.07785214659623,60.22450014472474],[20.077902388188278,60.22451898460454],[20.077941351057007,60.224551572479385]]],"type":"Polygon"},"id":1},{"type":"Feature","properties":{"type":"pin","hole":11,"color":"null"},"geometry":{"coordinates":[20.077592867511064,60.224565717308126],"type":"Point"}},{"type":"Feature","properties":{"type":"green","hole":12,"color":"null"},"geometry":{"coordinates":[[[20.075033991696513,60.22670929629925],[20.0750597191089,60.226714178935854],[20.07509074189284,60.226720648405996],[20.075106737454124,60.22673329780699],[20.075133846409737,60.22675624192088],[20.075168954882677,60.22677554091604],[20.075187838400836,60.22679736994469],[20.075203895238612,60.22682690385269],[20.075212579638084,60.22685514310071],[20.075210751957644,60.2268767966957],[20.075186838396024,60.22689668533089],[20.075140238758098,60.226913987051736],[20.075094467799788,60.2269240035451],[20.075031581575102,60.22693143002068],[20.074970523931738,60.226932740246095],[20.074913981598036,60.22692511805061],[20.074859267844667,60.22691238092803],[20.074829925826804,60.22689069648226],[20.074807955247296,60.22686259948964],[20.07479961765452,60.22683061741581],[20.074796961374475,60.22679863532865],[20.074800990372716,60.22676147330611],[20.074819874874794,60.226733485273115],[20.07484121588923,60.22670161213876],[20.074876323390206,60.22667361396383],[20.074920116178437,60.22665073069739],[20.074973565844974,60.22664052446125],[20.075033991696513,60.22670929629925]]],"type":"Polygon"},"id":22},{"type":"Feature","properties":{"type":"pin","hole":12,"color":"null"},"geometry":{"coordinates":[20.075055962280943,60.22678554091568],"type":"Point"},"id":23},{"type":"Feature","properties":{"type":"green","hole":13,"color":"null"},"geometry":{"coordinates":[[[20.071283904200897,60.22689060630486],[20.071342796818854,60.22686802710655],[20.071330637888735,60.2268655183056],[20.071408948392133,60.22685861910256],[20.071461997444146,60.22686300950474],[20.071504941914185,60.226878062307776],[20.071550412529376,60.22689875990059],[20.071585778564042,60.22691130388975],[20.071647669123962,60.226921966276876],[20.071714611974272,60.22693576465514],[20.071753767226596,60.226948935828716],[20.071790396332545,60.22697402376414],[20.071806816277274,60.22700350206347],[20.07180302705956,60.227031725942595],[20.071786607114802,60.22704928745486],[20.071733558064125,60.22706308577958],[20.071651458341734,60.22706559456509],[20.07155546481974,60.227051796241454],[20.071489785042047,60.2270386251092],[20.071427894482042,60.227014791617904],[20.07137105621368,60.226997230087136],[20.071299061071812,60.22697715975454],[20.0712611688933,60.22695332621885],[20.07125990581949,60.22691694868334],[20.071283904200897,60.22689060630486]]],"type":"Polygon"},"id":24},{"type":"Feature","properties":{"type":"pin","hole":13,"color":"null"},"geometry":{"coordinates":[20.071540307948823,60.226971514971325],"type":"Point"},"id":25},{"type":"Feature","properties":{"type":"green","hole":14,"color":"null"},"geometry":{"coordinates":[[[20.07398969835336,60.23126678167267],[20.074005520825807,60.23127564685413],[20.074014737063834,60.23128414488579],[20.07401734707699,60.23130338856933],[20.074054212014488,60.23132626786307],[20.074088443752288,60.23133607326878],[20.07412794191231,60.23135045452483],[20.07412794191231,60.23136418208193],[20.07410687622709,60.2313883687157],[20.074068694672235,60.23142497547914],[20.07401471385444,60.2314465473024],[20.074002864405855,60.23146681172986],[20.074000231195356,60.231496227811675],[20.073984431932388,60.231515184828424],[20.0739567832195,60.23152825862644],[20.073898852586012,60.231524990177576],[20.07381195663433,60.231524990177576],[20.0737448097627,60.231521068038205],[20.073661863626796,60.23150537947632],[20.073594716755167,60.23148053923819],[20.073590766939418,60.23146485065689],[20.07360919941425,60.23144916206809],[20.07361709904572,60.231432166088496],[20.07360656620375,60.23141713117599],[20.073585500518448,60.231397520410496],[20.073597349965667,60.231366143160926],[20.073632898309995,60.2313432638976],[20.073668446653045,60.23132103831219],[20.073727693893204,60.23129292946203],[20.073809323423802,60.231263513197405],[20.073901485796455,60.231260244722165],[20.07398969835336,60.23126678167267]]],"type":"Polygon"},"id":26},{"type":"Feature","properties":{"type":"pin","hole":14,"color":"null"},"geometry":{"coordinates":[20.073842261765776,60.23139265801751],"type":"Point"},"id":27},{"type":"Feature","properties":{"type":"green","hole":15,"color":"null"},"geometry":{"coordinates":[[[20.076207274792267,60.23081038105582],[20.076284549645834,60.23082435139034],[20.07631447104518,60.2308392075725],[20.07633878218249,60.23086149183305],[20.076329431744824,60.230901417761885],[20.076308860783143,60.23093391557495],[20.07624901798451,60.23097012738589],[20.076215356419112,60.230982197982485],[20.07618356493245,60.23098126947542],[20.076106891346797,60.23097291291006],[20.076063879335123,60.230965484850174],[20.07599468609979,60.23097848395378],[20.07594232365048,60.230985912010766],[20.075895571465082,60.23099334006608],[20.075818897879458,60.231000768119685],[20.075759055080823,60.231000768119685],[20.07569921228213,60.2309803409683],[20.075673031057505,60.2309515572332],[20.07564497974647,60.23090884583792],[20.075663680620806,60.23087077693893],[20.075697342194815,60.230843850129844],[20.07577214569318,60.23081878032207],[20.075865650065822,60.23080206710637],[20.075946063826137,60.230795567520346],[20.076095069454965,60.23079738188872],[20.076207274792267,60.23081038105582]]],"type":"Polygon"},"id":28},{"type":"Feature","properties":{"type":"pin","hole":15,"color":"null"},"geometry":{"coordinates":[20.075989075829142,60.23089306117615],"type":"Point"},"id":29},{"type":"Feature","properties":{"type":"green","hole":16,"color":"null"},"geometry":{"coordinates":[[[20.075537844051752,60.228078863197965],[20.07558620055724,60.22810078660331],[20.075588303013888,60.228126885876264],[20.075569380903204,60.22814985321921],[20.07553574159516,60.228172820546064],[20.075478975263138,60.228213535313216],[20.075432721214355,60.2282344146615],[20.075401184362903,60.22825216209699],[20.07538226225222,60.228280349180835],[20.07537805733898,60.228306448310576],[20.075342315574318,60.228335679311556],[20.075321291007015,60.22836491028647],[20.075241397650103,60.228381613688725],[20.075161504294186,60.22838787746264],[20.075108942875488,60.228372218025896],[20.075071098654234,60.22833881120303],[20.075052176543494,60.22828661297382],[20.075045869172612,60.22824381036381],[20.075062688826677,60.22820309563426],[20.075077406024064,60.228150897188925],[20.07510473796225,60.22813001778769],[20.075178323948222,60.22813314969858],[20.075218270626152,60.22814150145996],[20.075268729588288,60.22812479793504],[20.075312881179457,60.228092434831524],[20.075405389276142,60.22807259936528],[20.075483180176406,60.22806529155875],[20.075537844051752,60.228078863197965]]],"type":"Polygon"},"id":30},{"type":"Feature","properties":{"type":"pin","hole":16,"color":"null"},"geometry":{"coordinates":[20.075285549242324,60.228222931021804],"type":"Point"},"id":31},{"type":"Feature","properties":{"type":"green","hole":17,"color":"null"},"geometry":{"coordinates":[[[20.074569118672656,60.22664169487612],[20.074574741117544,60.226683573908446],[20.074577552337246,60.22670590937],[20.07456349623729,60.2267575600664],[20.07455225135851,60.22682177433222],[20.074524139160076,60.22685388141778],[20.074507271840474,60.22687761272175],[20.074496026956155,60.2269041359223],[20.07447353719712,60.22694741057373],[20.074462292318316,60.22701441637335],[20.074411690360847,60.22703535565739],[20.074358277182256,60.22703814756113],[20.07425988448702,60.227029771849544],[20.07420928252961,60.227018604231375],[20.074161491791756,60.22697114181037],[20.074091211294984,60.226916699536616],[20.074094022514657,60.22685388141667],[20.074127757153946,60.22682875413466],[20.07417273667201,60.226795251062526],[20.074228961068883,60.2267715196989],[20.07427394058695,60.22672545288509],[20.074285185465783,60.22668776180765],[20.07431048644446,60.22664588278175],[20.074361088401957,60.226615171461816],[20.074425746459355,60.226608191612485],[20.07450446061526,60.2266263392178],[20.074569118672656,60.22664169487612]]],"type":"Polygon"},"id":32},{"type":"Feature","properties":{"type":"pin","hole":17,"color":"null"},"geometry":{"coordinates":[20.07435827718777,60.22681898241004],"type":"Point"},"id":33},{"type":"Feature","properties":{"type":"green","hole":18,"color":"null"},"geometry":{"coordinates":[[[20.070172315885344,60.22539795535499],[20.07012183076577,60.22539376640998],[20.070096588209935,60.2253883941882],[20.070056921337482,60.225366905291764],[20.0700046331861,60.22535616083832],[20.069878420408543,60.22535616083832],[20.06979007146387,60.2253489978676],[20.069741389392618,60.22531049687191],[20.069759419789307,60.22529348478983],[20.06978466234517,60.22527557732528],[20.069800889702265,60.22523707624356],[20.069818920098925,60.22521558724799],[20.069894647765665,60.22518872598377],[20.069957754154444,60.22517708609578],[20.070055118297915,60.22516634158012],[20.070174118916242,60.22516186469758],[20.070266073940076,60.22516723695671],[20.07033639248806,60.225197679741115],[20.070394089758082,60.22522006412339],[20.070422938393136,60.22525229760686],[20.070451787027253,60.22528274031225],[20.070437362713392,60.22533080252566],[20.07040671104471,60.2253496053325],[20.070368847210915,60.2253863155413],[20.0703129529804,60.225404222945144],[20.070242634433328,60.22540869979474],[20.070172315885344,60.22539795535499]]],"type":"Polygon"},"id":34},{"type":"Feature","properties":{"type":"pin","hole":18,"color":"null"},"geometry":{"coordinates":[20.070123633805395,60.22527826344566],"type":"Point"},"id":35}]};

// Constants
const WEATHER_API_KEY = '99d688898682ba4fc727529cd0fbd7ac';
const CLUBS = [
    'Driver', 'Trä 3', 'Trä 5', 'Hybrid 3', 'Järn 4', 'Järn 5', 
    'Järn 6', 'Järn 7', 'Järn 8', 'Järn 9', 'PW', 'SW', 'LW'
];

// Default distances (meters) so users have sensible starting values they can edit
const DEFAULT_CLUB_DATA = {
    'Driver': { totalDistance: 230, carryDistance: 220 },
    'Trä 3': { totalDistance: 210, carryDistance: 200 },
    'Trä 5': { totalDistance: 195, carryDistance: 185 },
    'Hybrid 3': { totalDistance: 185, carryDistance: 175 },
    'Järn 4': { totalDistance: 170, carryDistance: 160 },
    'Järn 5': { totalDistance: 160, carryDistance: 150 },
    'Järn 6': { totalDistance: 150, carryDistance: 140 },
    'Järn 7': { totalDistance: 140, carryDistance: 130 },
    'Järn 8': { totalDistance: 130, carryDistance: 120 },
    'Järn 9': { totalDistance: 120, carryDistance: 110 },
    'PW': { totalDistance: 110, carryDistance: 95 },
    'SW': { totalDistance: 85, carryDistance: 80 },
    'LW': { totalDistance: 75, carryDistance: 70 }
};
// App State
let state = {
    currentHole: null,
    userPosition: null,
    weatherData: null,
    pinOffset: { x: 0, y: 0 },
    clubs: loadClubData(),
    watchId: null
};

// Layout persistence key
const LAYOUT_KEY = 'layoutOrder';

// Initialize App
document.addEventListener('DOMContentLoaded', () => {
    initializeApp();
});

function initializeApp() {
    createHoleButtons();
    setupEventListeners();
    loadLayoutOrder();
    // Start app with hole 1 selected by default
    selectHole(1);

    startLocationTracking();
}

// Club Data Management
function loadClubData() {
    const saved = localStorage.getItem('clubData');
    if (saved) {
        return JSON.parse(saved);
    }
    // Use predefined sensible defaults so users have values to edit from start
    const defaultClubs = {};
    CLUBS.forEach(club => {
        if (DEFAULT_CLUB_DATA[club]) {
            defaultClubs[club] = { 
                totalDistance: DEFAULT_CLUB_DATA[club].totalDistance,
                carryDistance: DEFAULT_CLUB_DATA[club].carryDistance
            };
        } else {
            defaultClubs[club] = { totalDistance: 0, carryDistance: 0 };
        }
    });
    return defaultClubs;
}

function saveClubData() {
    localStorage.setItem('clubData', JSON.stringify(state.clubs));
}

// UI Creation
function createHoleButtons() {
    const container = document.getElementById('holeButtons');
    if (!container) return;
    container.innerHTML = '';

    // Create compact select dropdown to save space
    const select = document.createElement('select');
    select.id = 'holeSelect';
    select.className = 'hole-select';


    for (let i = 1; i <= 18; i++) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = `Hål ${i}`;
        select.appendChild(opt);
    }

    select.addEventListener('change', (e) => {
        const val = parseInt(e.target.value, 10);
        if (!isNaN(val)) selectHole(val);
    });

    // Ensure dropdown shows Hål 1 by default (visual selection) or currentHole if set
    select.value = state.currentHole ? String(state.currentHole) : '1';

    container.appendChild(select);
}

function createClubSettings() {
    const container = document.getElementById('clubList');
    container.innerHTML = '';
    
    CLUBS.forEach(clubName => {
        const clubData = state.clubs[clubName];
        const item = document.createElement('div');
        item.className = 'club-item';
        item.innerHTML = `
            <div class="club-item-header">${clubName}</div>
            <div class="club-inputs">
                <div class="input-group">
                    <label>Totallängd (m)</label>
                    <input type="number" 
                           data-club="${clubName}" 
                           data-field="totalDistance" 
                           value="${clubData.totalDistance}" 
                           placeholder="0">
                </div>
                <div class="input-group">
                    <label>Längd utan rull (m)</label>
                    <input type="number" 
                           data-club="${clubName}" 
                           data-field="carryDistance" 
                           value="${clubData.carryDistance}" 
                           placeholder="0">
                </div>
            </div>
        `;
        container.appendChild(item);
    });
}

// Event Listeners
function setupEventListeners() {
    document.getElementById('settingsBtn').addEventListener('click', openSettings);
    document.getElementById('closeSettings').addEventListener('click', closeSettings);
    document.getElementById('saveSettings').addEventListener('click', saveSettings);
    
    document.getElementById('pinOffsetX').addEventListener('input', (e) => {
        state.pinOffset.x = parseFloat(e.target.value);
        document.getElementById('pinOffsetXValue').textContent = `${e.target.value} m`;
        updateDistances();
    });
    
    document.getElementById('pinOffsetY').addEventListener('input', (e) => {
        state.pinOffset.y = parseFloat(e.target.value);
        document.getElementById('pinOffsetYValue').textContent = `${e.target.value} m`;
        updateDistances();
    });
    
    document.getElementById('resetPin').addEventListener('click', resetPinPosition);

    // Layout edit buttons
    const editBtn = document.getElementById('editLayoutBtn');
    const resetLayoutBtn = document.getElementById('resetLayoutBtn');
    if (editBtn) {
        editBtn.addEventListener('click', () => {
            const enabled = document.body.classList.toggle('layout-edit');
            setDraggableState(enabled);
            if (enabled) setupDragHandlers();
        });
    }
    if (resetLayoutBtn) {
        resetLayoutBtn.addEventListener('click', () => {
            localStorage.removeItem(LAYOUT_KEY);
            location.reload();
        });
    }
}

function loadLayoutOrder() {
    try {
        const saved = localStorage.getItem(LAYOUT_KEY);
        if (!saved) return;
        const order = JSON.parse(saved);
        const container = document.querySelector('.main-content');
        if (!container) return;
        order.forEach(id => {
            const el = document.querySelector(`[data-layout-id="${id}"], #${id}`);
            if (el) container.appendChild(el);
        });
    } catch (e) {
        console.warn('Could not load layout order', e);
    }
}

function saveLayoutOrder() {
    const container = document.querySelector('.main-content');
    if (!container) return;
    const sections = Array.from(container.querySelectorAll('.card'));
    const order = sections.map(s => s.dataset.layoutId || s.id).filter(Boolean);
    localStorage.setItem(LAYOUT_KEY, JSON.stringify(order));
}

function setDraggableState(enabled) {
    document.querySelectorAll('.card').forEach(el => {
        if (enabled) {
            el.setAttribute('draggable', 'true');
            el.classList.add('draggable');
            if (!el.querySelector('.drag-handle')) {
                const handle = document.createElement('div');
                handle.className = 'drag-handle';
                handle.textContent = '⋮';
                el.appendChild(handle);
            }
        } else {
            el.removeAttribute('draggable');
            el.classList.remove('draggable');
            const h = el.querySelector('.drag-handle');
            if (h) h.remove();
        }
    });
}

// Drag & drop handlers
let draggedEl = null;
function setupDragHandlers() {
    const container = document.querySelector('.main-content');
    if (!container) return;

    container.addEventListener('dragstart', (e) => {
        const el = e.target.closest('.card');
        if (!el) return;
        draggedEl = el;
        e.dataTransfer.effectAllowed = 'move';
        try { e.dataTransfer.setData('text/plain', el.dataset.layoutId || el.id); } catch (err) {}
        el.classList.add('dragging');
    });

    container.addEventListener('dragend', () => {
        if (draggedEl) draggedEl.classList.remove('dragging');
        draggedEl = null;
        saveLayoutOrder();
    });

    container.addEventListener('dragover', (e) => {
        e.preventDefault();
        const afterEl = getDragAfterElement(container, e.clientY);
        if (!draggedEl) return;
        if (afterEl == null) {
            container.appendChild(draggedEl);
        } else {
            container.insertBefore(draggedEl, afterEl);
        }
    });

    container.addEventListener('drop', (e) => {
        e.preventDefault();
        saveLayoutOrder();
    });
}

function getDragAfterElement(container, y) {
    const draggableEls = [...container.querySelectorAll('.card:not(.dragging)')];
    let closest = { offset: Number.NEGATIVE_INFINITY, element: null };
    draggableEls.forEach(child => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
            closest = { offset, element: child };
        }
    });
    return closest.element;
}

function openSettings() {
    createClubSettings();
    document.getElementById('settingsModal').classList.add('active');
}

function closeSettings() {
    document.getElementById('settingsModal').classList.remove('active');
}

function saveSettings() {
    const inputs = document.querySelectorAll('#clubList input');
    inputs.forEach(input => {
        const club = input.dataset.club;
        const field = input.dataset.field;
        state.clubs[club][field] = parseFloat(input.value) || 0;
    });
    saveClubData();
    closeSettings();
    if (state.currentHole) {
        updateDistances();
    }
}

// Location Tracking
function startLocationTracking() {
    if (!navigator.geolocation) {
        alert('GPS stöds inte av din enhet');
        return;
    }
    
    state.watchId = navigator.geolocation.watchPosition(
        (position) => {
            state.userPosition = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                altitude: position.coords.altitude || 0
            };
            if (state.currentHole) {
                // Fetch weather once when GPS becomes available and weather not yet loaded
                if (!state.weatherData) fetchWeather();
                updateDistances();
            }
        },
        (error) => {
            console.error('GPS error:', error);
            document.getElementById('distanceToGreen').innerHTML = 
                '<span class="loading">❌ GPS-fel</span>';
        },
        { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
    );
}

// Hole Selection
function selectHole(holeNumber) {
    state.currentHole = holeNumber;
    // Update UI: set select value if present
    const selectEl = document.getElementById('holeSelect');
    if (selectEl) selectEl.value = holeNumber;
    
    // Show relevant sections
    document.getElementById('pinAdjustment').style.display = 'block';
    document.getElementById('weatherInfo').style.display = 'block';
    document.getElementById('clubRecommendation').style.display = 'block';
    
    // Load and display hole image
    const holeImageEl = document.getElementById('holeImage');
    const holeImageImg = document.getElementById('holeImageElement');
    if (holeImageEl && holeImageImg) {
        holeImageEl.style.display = 'block';
        holeImageImg.src = `img/s${holeNumber}.jpg`;
        holeImageImg.alt = `Hål ${holeNumber} layout`;
    }
    
    // Reset pin position
    resetPinPosition();
    
    // Fetch weather
    fetchWeather();
    
    // Update distances
    if (state.userPosition) {
        updateDistances();
    }
}

function resetPinPosition() {
    state.pinOffset = { x: 0, y: 0 };
    document.getElementById('pinOffsetX').value = 0;
    document.getElementById('pinOffsetY').value = 0;
    document.getElementById('pinOffsetXValue').textContent = '0 m';
    document.getElementById('pinOffsetYValue').textContent = '0 m';
    if (state.currentHole && state.userPosition) {
        updateDistances();
    }
}

// Weather API
async function fetchWeather() {
    if (!state.userPosition) return;
    
    try {
        const response = await fetch(
            `https://api.openweathermap.org/data/2.5/weather?lat=${state.userPosition.lat}&lon=${state.userPosition.lng}&appid=${WEATHER_API_KEY}&units=metric`
        );
        state.weatherData = await response.json();
        updateWeatherDisplay();
    } catch (error) {
        console.error('Weather fetch error:', error);
    }
}

function updateWeatherDisplay() {
    if (!state.weatherData) return;
    
    const temp = Math.round(state.weatherData.main.temp);
    const windSpeed = Math.round(state.weatherData.wind.speed * 10) / 10; // m/s
    const windDir = getWindDirection(state.weatherData.wind.deg);
    const humidity = state.weatherData.main.humidity;
    
    document.getElementById('temperature').textContent = `${temp}°C`;
    document.getElementById('windSpeed').textContent = `${windSpeed} m/s`;
    document.getElementById('windDirection').textContent = windDir;
    document.getElementById('humidity').textContent = `${humidity}%`;
}

function getWindDirection(degrees) {
    const directions = ['N', 'NNÖ', 'NÖ', 'ÖNÖ', 'Ö', 'ÖSÖ', 'SÖ', 'SSÖ', 'S', 'SSV', 'SV', 'VSV', 'V', 'VNV', 'NV', 'NNV'];
    const index = Math.round(degrees / 22.5) % 16;
    return directions[index];
}

// Distance Calculations
function updateDistances() {
    if (!state.currentHole || !state.userPosition) return;
    
    const holeData = getHoleData(state.currentHole);
    if (!holeData) return;
    
    const pinPosition = getPinPosition(holeData);
    const greenPolygon = getGreenPolygon(holeData);
    
    // Calculate distances
    const distanceToPin = calculateDistance(state.userPosition, pinPosition);
    const distanceToFront = calculateDistanceToFrontEdge(state.userPosition, greenPolygon);
    const distanceToBack = calculateDistanceToBackEdge(state.userPosition, greenPolygon);
    
    // Update UI
    document.getElementById('distanceToGreen').innerHTML = 
        `<span style="font-size: 3rem;">${Math.round(distanceToPin)}</span> <span style="font-size: 1.5rem;">m</span>`;
    document.getElementById('frontEdge').textContent = `${Math.round(distanceToFront)} m`;
    document.getElementById('centerPin').textContent = `${Math.round(distanceToPin)} m`;
    document.getElementById('backEdge').textContent = `${Math.round(distanceToBack)} m`;
    
    // Calculate elevation
    const elevation = calculateElevation(holeData, state.userPosition);
    
    // Recommend club
    recommendClub(distanceToPin, elevation);
}

function getHoleData(holeNumber) {
    return GOLF_COURSE_DATA.features.filter(f => 
        f.properties.hole === holeNumber
    );
}

function getPinPosition(holeData) {
    const pin = holeData.find(f => f.properties.type === 'pin');
    if (!pin) return null;
    
    const [lng, lat] = pin.geometry.coordinates;
    
    // Apply offset
    const offsetLat = lat + (state.pinOffset.y / 111320); // ~111.32km per degree
    const offsetLng = lng + (state.pinOffset.x / (111320 * Math.cos(lat * Math.PI / 180)));
    
    return { lat: offsetLat, lng: offsetLng };
}

function getGreenPolygon(holeData) {
    const green = holeData.find(f => f.properties.type === 'green');
    if (!green) return null;
    
    return green.geometry.coordinates[0].map(coord => ({
        lng: coord[0],
        lat: coord[1]
    }));
}

function calculateDistance(pos1, pos2) {
    const R = 6371e3; // Earth's radius in meters
    const φ1 = pos1.lat * Math.PI / 180;
    const φ2 = pos2.lat * Math.PI / 180;
    const Δφ = (pos2.lat - pos1.lat) * Math.PI / 180;
    const Δλ = (pos2.lng - pos1.lng) * Math.PI / 180;

    const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
              Math.cos(φ1) * Math.cos(φ2) *
              Math.sin(Δλ/2) * Math.sin(Δλ/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c;
}

function calculateDistanceToFrontEdge(userPos, polygon) {
    if (!polygon) return 0;
    let minDistance = Infinity;
    
    polygon.forEach(point => {
        const dist = calculateDistance(userPos, point);
        if (dist < minDistance) {
            minDistance = dist;
        }
    });
    
    return minDistance;
}

function calculateDistanceToBackEdge(userPos, polygon) {
    if (!polygon) return 0;
    let maxDistance = 0;
    
    polygon.forEach(point => {
        const dist = calculateDistance(userPos, point);
        if (dist > maxDistance) {
            maxDistance = dist;
        }
    });
    
    return maxDistance;
}

function calculateElevation(holeData, userPos) {
    // Simplified elevation - in production, use elevation API
    return 0; // Placeholder
}

// Club Recommendation
function recommendClub(distance, elevation) {
    if (!state.weatherData) return;
    
    // Calculate adjustments
    const tempAdjustment = calculateTemperatureAdjustment(state.weatherData.main.temp);
    const windAdjustment = calculateWindAdjustment(distance);
    const humidityAdjustment = calculateHumidityAdjustment(state.weatherData.main.humidity);
    const elevationAdjustment = calculateElevationAdjustment(elevation);
    const pressureAdjustment = calculatePressureAdjustment(state.weatherData.main.pressure);
    
    const totalAdjustment = tempAdjustment + windAdjustment + humidityAdjustment + 
                           elevationAdjustment + pressureAdjustment;
    
    const adjustedDistance = distance - totalAdjustment;
    
    // Find best club
    let bestClub = null;
    let minDiff = Infinity;
    
    Object.entries(state.clubs).forEach(([name, data]) => {
        if (data.totalDistance === 0) return;
        const diff = Math.abs(data.totalDistance - adjustedDistance);
        if (diff < minDiff) {
            minDiff = diff;
            bestClub = { name, ...data };
        }
    });
    
    if (bestClub) {
        document.querySelector('.club-name').textContent = bestClub.name;
        document.querySelector('.club-distance').textContent = 
            `${Math.round(bestClub.totalDistance)} m (${Math.round(bestClub.carryDistance)} m carry)`;
    } else {
        document.querySelector('.club-name').textContent = 'Ställ in klubbor';
        document.querySelector('.club-distance').textContent = 'Gå till inställningar';
    }
    
    // Wind adjustment for aim
    updateWindAdjustment();
    
    // Show impact details
    updateImpactDetails(tempAdjustment, windAdjustment, humidityAdjustment, 
                       elevationAdjustment, pressureAdjustment);
}

function calculateTemperatureAdjustment(temp) {
    // ~1m per 5°C above/below 20°C
    const baseTemp = 20;
    return (temp - baseTemp) * 0.2;
}

function calculateWindAdjustment(distance) {
    if (!state.weatherData || !state.userPosition) return 0;
    
    const windSpeed = state.weatherData.wind.speed; // m/s
    const windDeg = state.weatherData.wind.deg;
    
    // Get bearing to pin
    const holeData = getHoleData(state.currentHole);
    const pinPos = getPinPosition(holeData);
    if (!pinPos) return 0;
    
    const bearing = calculateBearing(state.userPosition, pinPos);
    const windEffect = Math.cos((windDeg - bearing) * Math.PI / 180);
    
    // Headwind reduces distance, tailwind increases
    return -windSpeed * windEffect * 2; // ~2m per m/s wind
}

function calculateHumidityAdjustment(humidity) {
    // High humidity slightly increases distance
    return (humidity - 50) * 0.05;
}

function calculateElevationAdjustment(elevation) {
    // ~1m per 1m elevation difference
    return elevation * 1.0;
}

function calculatePressureAdjustment(pressure) {
    // Standard pressure is 1013 hPa
    // ~1m per 10 hPa difference
    return (1013 - pressure) * 0.1;
}

function calculateBearing(pos1, pos2) {
    const φ1 = pos1.lat * Math.PI / 180;
    const φ2 = pos2.lat * Math.PI / 180;
    const Δλ = (pos2.lng - pos1.lng) * Math.PI / 180;
    
    const y = Math.sin(Δλ) * Math.cos(φ2);
    const x = Math.cos(φ1) * Math.sin(φ2) -
              Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
    const θ = Math.atan2(y, x);
    
    return (θ * 180 / Math.PI + 360) % 360;
}

function updateWindAdjustment() {
    if (!state.weatherData || !state.userPosition) return;
    
    const holeData = getHoleData(state.currentHole);
    const pinPos = getPinPosition(holeData);
    if (!pinPos) return;
    
    const windDeg = state.weatherData.wind.deg;
    const windSpeed = state.weatherData.wind.speed; // m/s
    const bearing = calculateBearing(state.userPosition, pinPos);
    
    // Calculate cross-wind component
    const crossWind = Math.sin((windDeg - bearing) * Math.PI / 180) * windSpeed;
    const aimAdjustment = Math.round(Math.abs(crossWind) * 2); // ~2m per m/s crosswind
    
    const windAdjustmentEl = document.getElementById('windAdjustment');
    const windAdjustmentText = document.getElementById('windAdjustmentText');
    
    if (Math.abs(aimAdjustment) > 1) {
        windAdjustmentEl.style.display = 'block';
        const direction = crossWind > 0 ? 'höger' : 'vänster';
        windAdjustmentText.textContent = `Sikta ${aimAdjustment}m till ${direction} om flaggan`;
    } else {
        windAdjustmentEl.style.display = 'none';
    }
}

function updateImpactDetails(temp, wind, humidity, elevation, pressure) {
    const impactList = document.getElementById('impactList');
    impactList.innerHTML = '';
    
    const impacts = [
        { label: 'Temperatur', value: temp },
        { label: 'Vind', value: wind },
        { label: 'Luftfuktighet', value: humidity },
        { label: 'Höjdskillnad', value: elevation },
        { label: 'Lufttryck', value: pressure }
    ];
    
    impacts.forEach(impact => {
        if (Math.abs(impact.value) < 0.5) return;
        
        const item = document.createElement('div');
        item.className = 'impact-item';
        
        const valueClass = impact.value > 0 ? 'positive' : 'negative';
        const sign = impact.value > 0 ? '+' : '';
        
        item.innerHTML = `
            <span class="impact-label">${impact.label}</span>
            <span class="impact-value ${valueClass}">${sign}${Math.round(impact.value)} m</span>
        `;
        
        impactList.appendChild(item);
    });
    
    if (impactList.children.length === 0) {
        impactList.innerHTML = '<div class="impact-item"><span class="impact-label">Inga betydande effekter</span></div>';
    }
}

// Service Worker Registration
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('Service Worker registered'))
            .catch(err => console.log('Service Worker registration failed:', err));
    });
}
